<!DOCTYPE html>
<html>
<head>
    <title>IPL Auction 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: Arial; margin: 0; padding: 20px; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .player-info, .bidding, .teams, .team-detail { border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        .bid-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;}
        .bid-btn { padding: 10px; font-size: 14px; border-radius:5px;}
        .bid-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .control-btn { padding: 15px 30px; margin: 10px; font-size: 16px; border-radius:5px; cursor:pointer;}
        .auctioneer-only { display: none; }
        .leader-glow { border: 3px solid #00ff00; box-shadow: 0 0 15px #00ff00; }
        .teams-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top:10px;}
        .team-card { border:1px solid #ddd; padding:10px; border-radius:8px;}
        .progress-container { background:#eee; width:100%; border-radius:5px; margin-bottom:5px; }
        .progress-bar { height:15px; border-radius:5px; background:#4CAF50; text-align:right; padding-right:5px; color:white; font-size:12px;}
        #ui-message { display:none; padding:10px; background:#ffeb3b; margin-bottom:10px; border-radius:5px;}
        .warning-msg { color:red; font-weight:bold; font-size:14px; margin-top:5px;}
    </style>
</head>
<body>
<h1>üèè IPL Auction 2026 - {{ role|title }}</h1>
<div id="ui-message"></div>

<div class="container">
    <!-- Player Info -->
    <div class="player-info">
        <h2>Current Player</h2>
        <div id="player-details">No player loaded</div>
    </div>

    <!-- Bidding Section -->
    <div class="bidding">
        <h2>Live Bidding</h2>
        <p><strong>Current Bid:</strong> ‚Çπ<span id="current-bid">0</span> Cr</p>
        <p><strong>Leader:</strong> <span id="leader">-</span></p>

        <div class="bid-buttons" id="bid-buttons"></div>

        <div class="auctioneer-only">
            <button class="control-btn" onclick="undoBid()">‚Ü∂ Undo Bid</button>
        </div>
    </div>
</div>

<!-- Teams Display -->
<div class="teams">
    <h2>Team Summary</h2>
    <div class="teams-grid" id="teams-grid"></div>
</div>

<!-- Auctioneer Controls -->
<div class="auctioneer-only" id="auctioneer-controls">
    <button class="control-btn" onclick="nextPlayer()" style="background: #4CAF50; color:white;">‚ñ∂ Next Player</button>
    <button class="control-btn" onclick="resetAuction()" style="background:#f44336; color:white;">üîÑ Reset Auction</button>
    <button class="control-btn" onclick="downloadSummary()" style="background:#2196F3; color:white;">üíæ Download Summary</button>
    <button class="control-btn" onclick="undoNextPlayer()" style="background:#ff9800; color:white;">‚¨Ö Undo Next Player</button>
</div>

<script>
const socket = io();
const isAuctioneer = "{{ role }}" === "auctioneer";
if(isAuctioneer) document.querySelectorAll('.auctioneer-only').forEach(el=>el.style.display='block');

socket.on('auction_update', function(data){
    updatePlayerInfo(data.player);
    updateBidding(data.current_bid, data.leader);
    updateTeams(data.teams);
    updateBidButtons(data.teams, data.player);

    if(data.ui_message) showMessage(data.ui_message);
});

socket.on('download_csv', function(csv){
    const blob = new Blob([csv], {type:'text/csv'});
    const link = document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download='auction_summary.csv';
    link.click();
});

function updatePlayerInfo(player){
    const container=document.getElementById('player-details');
    if(player){
        container.innerHTML=`
            <p><strong>Name:</strong> ${player.Name}</p>
            <p><strong>Team:</strong> ${player.Team}</p>
            <p><strong>Role:</strong> ${player.Role}</p>
            <p><strong>Nationality:</strong> ${player.Nationality}</p>
            <p><strong>Base Price:</strong> ‚Çπ${player['Base Price']} Cr</p>
            <p><strong>Status:</strong> ${player.Uncapped==='Y'?'Uncapped üü¢':'Capped üîµ'}</p>
        `;
    } else container.innerHTML='No player available';
}

function updateBidding(bid, leader){
    document.getElementById('current-bid').textContent=bid||0;
    document.getElementById('leader').textContent=leader||'-';
}

function updateBidButtons(teams, player){
    const container=document.getElementById('bid-buttons');
    container.innerHTML='';
    teams.forEach(team=>{
        const btn=document.createElement('button');
        btn.textContent=team.name;
        btn.className='bid-btn';
        btn.disabled=!isAuctioneer;
        if(team.is_leader){ btn.style.backgroundColor='#4CAF50'; btn.style.color='white'; }
        btn.onclick=()=>placeBid(team.name);
        container.appendChild(btn);
    });
}

function updateTeams(teams){
    const container=document.getElementById('teams-grid');
    container.innerHTML='';
    teams.forEach(team=>{
        const div=document.createElement('div'); div.className='team-card';
        if(team.is_leader) div.classList.add('leader-glow');
        const squad_pct = Math.round((team.players/15)*100);
        div.innerHTML=`
            <h4>üèè ${team.name}</h4>
            <div class="progress-container"><div class="progress-bar" style="width:${squad_pct}%;background:#2196F3;">${team.players}/15</div></div>
            <p><strong>Spent:</strong> ‚Çπ${team.spent} Cr</p>
            <p style="color:${team.purse<24?'red':'green'}"><strong>Remaining:</strong> ‚Çπ${team.purse} Cr</p>
            <p><strong>Overseas:</strong> ${team.overseas}/6 | Uncapped: ${team.uncapped}/1</p>
            <div><strong>Roles:</strong></div>
            <div class="progress-container"><div class="progress-bar" style="width:${Math.min(team.roles.Bat/4,1)*100}%;">Bat ${team.roles.Bat}/4</div></div>
            <div class="progress-container"><div class="progress-bar" style="width:${Math.min(team.roles.Bowl/4,1)*100}%;">Bowl ${team.roles.Bowl}/4</div></div>
            <div class="progress-container"><div class="progress-bar" style="width:${Math.min(team.roles.AR/2,1)*100}%;">AR ${team.roles.AR}/2</div></div>
            <div class="progress-container"><div class="progress-bar" style="width:${Math.min(team.roles.WK/1,1)*100}%;">WK ${team.roles.WK}/1</div></div>
        `;
        container.appendChild(div);
    });
}

function placeBid(team){ socket.emit('place_bid',{team}); }
function undoBid(){ socket.emit('undo_bid'); }
function nextPlayer(){ socket.emit('next_player'); }
function undoNextPlayer(){
    socket.emit('undo_next_player');
}
function resetAuction(){ if(confirm('Reset auction?')) socket.emit('reset_auction'); }
function downloadSummary(){ socket.emit('request_summary'); }

function showMessage(msg){
    const el=document.getElementById('ui-message'); el.textContent=msg; el.style.display='block';
    setTimeout(()=>{el.style.display='none';},4000);
}
</script>
</body>
</html>